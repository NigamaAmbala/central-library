sap.ui.define(["./BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Token","sap/m/MessageBox","sap/m/MessageToast","sap/ui/core/Fragment"],function(e,t,o,s,i,r,n){"use strict";return e.extend("com.app.librarysystem.controller.AllBooks",{onInit:function(){var e=this.getView();var t=e.byId("idISBNFilterValue12");var o=e.byId("idtitleFilterValue12");var i=e.byId("iAuthorFilterValue12");var r=e.byId("idbookidFilterValue12");let n=function(e){if(true){var t=e.text;return new s({key:t,text:t})}};t.addValidator(n);o.addValidator(n);i.addValidator(n);r.addValidator(n);const a=this.getOwnerComponent().getRouter();a.attachRoutePatternMatched(this.onUserDetailsLoad,this)},onUserDetailsLoad:function(e){const{id:t}=e.getParameter("arguments");this.ID=t;const o=this.getView().byId("idUserListPage");o.bindElement(`/Users(${t})`)},onGoPressAllBooks:function(){const e=this.getView(),s=e.byId("idISBNFilterValue12"),i=s.getTokens(),r=e.byId("idtitleFilterValue12"),n=r.getTokens(),a=e.byId("iAuthorFilterValue12"),l=a.getTokens(),d=e.byId("idbookidFilterValue12"),u=d.getTokens(),c=e.byId("idAllBooksTable"),h=[];i.filter(e=>{e?h.push(new t("ISBN",o.EQ,e.getKey())):""});n.filter(e=>{e?h.push(new t("title",o.EQ,e.getKey())):""});l.filter(e=>{e?h.push(new t("author",o.EQ,e.getKey())):""});u.filter(e=>{e?h.push(new t("ID",o.EQ,e.getKey())):""});c.getBinding("items").filter(h)},onClearFilterPressAllbooks:function(){const e=this.getView(),t=e.byId("idISBNFilterValue12").removeAllTokens(),o=e.byId("idtitleFilterValue12").removeAllTokens(),s=e.byId("iAuthorFilterValue12").removeAllTokens(),i=e.byId("idbookidFilterValue12").removeAllTokens()},reservebutton:async function(e){debugger;var t=this.byId("idAllBooksTable").getSelectedItem().getBindingContext().getObject();var o=this.getView().getModel("ModelV2");if(!t){r.show("Please select a Book");return}i.confirm("Are you sure you want to reserve this book?",{title:"Confirm Reservation",onClose:async function(e){if(e===i.Action.OK){if(this.byId("idAllBooksTable").getSelectedItems().length>1){r.show("Please Select only one Book");return}if(t.quantityAvailable===0){r.show("Book is not available");return}var s=t.quantityAvailable-1;const e=await this.bookInactiveLoans(t.ID,this.ID);if(e){r.show("You have an active loan for the selected book.");return}const n=await this.checkIfBookIsReservedByUser(t.ID,this.ID);if(n){i.error("This book is already reserved by you.");return}const a=new sap.ui.model.json.JSONModel({users_ID:this.ID,books_ID:t.ID,Reservationdate:new Date,books:{quantityAvailable:s}});this.getView().setModel(a,"userModel");const l=this.getView().getModel("userModel").getProperty("/");try{await this.createData(o,l,"/Reservation");o.refresh();sap.m.MessageBox.success(`${t.title} Book Reserved`);this.getView().byId("idAllBooksTable").getBinding("items").refresh()}catch(e){i.error("Some technical issue occurred.")}}else{r.show("Reservation canceled.")}}.bind(this)})},checkIfBookIsReservedByUser:function(e,s){return new Promise((i,r)=>{const n=this.getView().getModel("ModelV2");const a=[new t("books_ID",o.EQ,e),new t("users_ID",o.EQ,s)];n.read("/Reservation",{filters:a,success:function(e){i(e.results.length>0)},error:function(e){r(e)}})})},bookInactiveLoans:function(e,s){return new Promise((i,r)=>{const n=this.getView().getModel("ModelV2");const a=[new t("books_ID",o.EQ,e),new t("users_ID",o.EQ,s)];n.read("/Loans",{filters:a,success:function(e){const t=e.results.some(e=>!e.ReturnDate);i(t)},error:function(e){r(e)}})})}})});
//# sourceMappingURL=AllBooks.controller.js.map