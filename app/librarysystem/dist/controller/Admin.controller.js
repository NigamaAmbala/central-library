sap.ui.define(["./BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Token","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/model/odata/v2/ODataModel","sap/m/MessageToast"],function(e,t,o,i,s,a,n,l,r){"use strict";return e.extend("com.app.librarysystem.controller.Admin",{onInit:function(){var e=this.getView();var t=e.byId("idISBNFilterValue");var o=e.byId("idtitleFilterValue");var a=e.byId("iAuthorFilterValue");var n=e.byId("idbookidFilterValue");let l=function(e){if(true){var t=e.text;return new i({key:t,text:t})}};t.addValidator(l);o.addValidator(l);a.addValidator(l);n.addValidator(l);const r=new s({ID:"",title:"",author:"",ISBN:"",genre:"",stock:"",quantityAvailable:"",language:""});this.getView().setModel(r,"localModel");this.getRouter().attachRoutePatternMatched(this.onBookListLoad,this);var d=new s({users:{ID:"",books:{ISBN:""}},dueDate:"",issueDate:""});this.getView().setModel(d,"ActiveloanModel")},onBookListLoad:function(){this.getView().byId("idBooksTable").getBinding("items").refresh()},onGoPress:function(){const e=this.getView(),i=e.byId("idISBNFilterValue"),s=i.getTokens(),a=e.byId("idtitleFilterValue"),n=a.getTokens(),l=e.byId("iAuthorFilterValue"),r=l.getTokens(),d=e.byId("idbookidFilterValue"),g=d.getTokens(),u=e.byId("idBooksTable"),c=[];s.filter(e=>{e?c.push(new t("ISBN",o.EQ,e.getKey())):""});n.filter(e=>{e?c.push(new t("title",o.EQ,e.getKey())):""});r.filter(e=>{e?c.push(new t("author",o.EQ,e.getKey())):""});g.filter(e=>{e?c.push(new t("ID",o.EQ,e.getKey())):""});u.getBinding("items").filter(c)},onClearFilterPress:function(){const e=this.getView(),t=e.byId("idISBNFilterValue").removeAllTokens(),o=e.byId("idtitleFilterValue").removeAllTokens(),i=e.byId("iAuthorFilterValue").removeAllTokens(),s=e.byId("idbookidFilterValue").removeAllTokens()},addButton:async function(){if(!this.oCreateBooksDialog){this.oCreateBooksDialog=await a.load({id:this.getView().getId(),name:"com.app.librarysystem.Fragments.CreateBookDialog",controller:this});this.getView().addDependent(this.oCreateBooksDialog)}this.oCreateBooksDialog.open()},onCloseDialog:function(){if(this.oCreateBooksDialog.isOpen()){this.oCreateBooksDialog.close()}},onCreateBook:async function(){const e=this.getView().getModel("localModel").getProperty("/"),t=this.getView().getModel("ModelV2");e.quantityAvailable=e.stock;try{const o=await this.checkTitle(t,e.title,e.ISBN);if(o){n.success("Book already exsist");return}await this.createData(t,e,"/Books");this.getView().byId("idBooksTable").getBinding("items").refresh();this.oCreateBooksDialog.close()}catch(e){this.oCreateBooksDialog.close();n.error("Some technical Issue")}},checkTitle:async function(e,i,s){return new Promise((a,n)=>{e.read("/Books",{filters:[new t("title",o.EQ,i),new t("ISBN",o.EQ,s)],success:function(e){a(e.results.length>0)},error:function(){n("An error occurred while checking username existence.")}})})},DeleteBook:async function(){var e=this;var t=this.byId("idBooksTable").getSelectedItems();if(t.length>0){n.confirm("Are you sure you want to delete the selected book(s)?",{title:"Confirm Deletion",onClose:function(o){if(o===n.Action.OK){var i=[];t.forEach(function(e){var t=e.getBindingContext().getObject().title;var o=e.getBindingContext().getObject().stock;var s=e.getBindingContext().getObject().quantityAvailable;if(o==s){i.push(t);e.getBindingContext().delete("$auto")}else{n.error("Book has a Active loan");return}});Promise.all(i.map(function(e){return new Promise(function(t,o){t(e+" Successfully Deleted")})})).then(function(e){e.forEach(function(e){n.success(e)})}).catch(function(e){n.error("Deletion Error: "+e)});e.getView().byId("idBooksTable").removeSelections(true);e.getView().byId("idBooksTable").getBinding("items").refresh()}}});jQuery(".sapMMessageBoxText").css("color","red")}else{n.error("Please Select Rows to Delete")}},PressActiveloans:function(){const e=this.getRouter();e.navTo("RouteActiveLoans")},onIssuebutton:async function(){if(!this.oIssuebookDailog){this.oIssuebookDailog=await a.load({id:this.getView().getId(),name:"com.app.librarysystem.Fragments.IssueBookDialog",controller:this});this.getView().addDependent(this.oIssuebookDailog)}this.oIssuebookDailog.open()},onissuebookscancelbtn:function(){if(this.oIssuebookDailog.isOpen()){this.oIssuebookDailog.close()}},onIssuebtnpress:async function(e){console.log(this.byId("issuebooksTable").getSelectedItem().getBindingContext().getObject());if(this.byId("issuebooksTable").getSelectedItems().length>1){r.show("Please Select only one Book");return}var t=this.byId("issuebooksTable").getSelectedItem().getBindingContext().getObject(),o=t.books.quantityAvailable-1;var i=new Date;let s=new Date(i.getFullYear(),i.getMonth()+1,i.getDay()+1);const a=new sap.ui.model.json.JSONModel({books_ID:t.books.ID,users_ID:t.users.ID,issuseDate:new Date,ReturnDate:s,notify:`Your reserved book " ${t.books.title} " is issued`,books:{quantityAvailable:o}});this.getView().setModel(a,"userModel");const n=this.getView().getModel("userModel").getProperty("/"),l=this.getView().getModel("ModelV2");try{await this.createData(l,n,"/Loans");sap.m.MessageBox.success("Book is issued");this.byId("issuebooksTable").getSelectedItem().getBindingContext().delete("$auto");l.update("/Books("+t.books.ID+")",n.books,{success:function(){},error:function(e){sap.m.MessageBox.error("Failed to update book: "+e.message)}.bind(this)})}catch(e){sap.m.MessageBox.error("Some technical Issue")}},EditBook:async function(){var e=this.byId("idBooksTable").getSelectedItems();if(e.length===0){r.show("Please selete atleast one book to edit");return}if(e.length>1){r.show("Please selete only one book to edit");return}if(e){var t=e[0].getBindingContext().getProperty("ID");var o=e[0].getBindingContext().getProperty("author");var i=e[0].getBindingContext().getProperty("title");this.oStock=e[0].getBindingContext().getProperty("stock");var s=e[0].getBindingContext().getProperty("ISBN");var n=e[0].getBindingContext().getProperty("genre");var l=e[0].getBindingContext().getProperty("language");this.oAq=e[0].getBindingContext().getProperty("quantityAvailable");var d=new sap.ui.model.json.JSONModel({ID:t,title:i,author:o,ISBN:s,genre:n,stock:this.oStock,language:l,quantityAvailable:this.oAq});this.getView().setModel(d,"newBookModel");if(!this.oEditBooksDialog){this.oEditBooksDialog=await a.load({id:this.getView().getId(),name:"com.app.librarysystem.Fragments.EditBookDialog",controller:this});this.getView().addDependent(this.oEditBooksDialog)}this.oEditBooksDialog.open()}},onCloseEdit:function(){if(this.oEditBooksDialog.isOpen()){this.oEditBooksDialog.close()}},onSave:function(){console.log(this.oStock);console.log(this.oAq);var e=parseInt(this.getView().byId("idEditBookstockVal").getValue());var t=parseInt(this.getView().byId("idEditBookquantityAvailableVal").getValue());if(this.oStock<e){e=e-this.oStock;t=t+e}else if(this.oStock>e){e=this.oStock-e;t=t-e}else{t=t}console.log(e);var o=this.getView().getModel("newBookModel").getData();o.quantityAvailable=t;this.getView().getModel("newBookModel").setData(o);var i=this.getOwnerComponent().getModel("ModelV2");console.log(i.getMetadata().getName());try{i.update("/Books("+o.ID+")",o,{success:function(){this.getView().byId("idBooksTable").getBinding("items").refresh();this.oEditBooksDialog.close()}.bind(this),error:function(e){this.oEditBooksDialog.close();sap.m.MessageBox.error("Failed to update book: "+e.message)}.bind(this)})}catch(e){this.oEditBooksDialog.close();sap.m.MessageBox.error("Some technical Issue")}var i=new sap.ui.model.odata.v2.ODataModel({serviceUrl:"https://port4004-workspaces-ws-2fljr.us10.trial.applicationstudio.cloud.sap/v2/BooksSRV",defaultBindingMode:sap.ui.model.BindingMode.TwoWay,messageParser:sap.ui.model.odata.ODataMessageParser})},onLogoutbutton1:function(){var e=this.getOwnerComponent().getRouter();e.navTo("RouteHomeview",{},true)},PressUsers:function(){const e=this.getRouter();e.navTo("RouteAllUsers")}})});
//# sourceMappingURL=Admin.controller.js.map